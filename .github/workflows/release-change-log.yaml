name: Release Changelog to Discord

on:
  release:
    types: [published]

jobs:
  notify-discord:
    if: github.event.release.target_commitish == 'main'
    runs-on: ubuntu-latest

    steps:
    - name: Format and send changelog to Discord
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        BODY='${{ github.event.release.body }}'
        TAG_NAME='${{ github.event.release.tag_name }}'
        NAME='${{ github.event.release.name }}'
        URL='${{ github.event.release.html_url }}'
        
        WHATS_CHANGED=$(echo "$BODY" | awk '/## [Ww]hat.?s [Cc]hanged/{flag=1; next} /^## /{flag=0} flag' | sed 's/\\r//g')
        
        if [ -z "$WHATS_CHANGED" ]; then
          WHATS_CHANGED="No changes listed."
        fi
        
        FULL_CHANGELOG_URL=$(echo "$BODY" | grep -o 'https://github.com[^ ]*commits[^ ]*' || echo "$URL")
        
        ESCAPED_WHATS_CHANGED=$(echo "$WHATS_CHANGED" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed 's/\r//g' | sed 's/\n/\\n/g')
        
        DISCORD_PAYLOAD=$(cat <<EOF
        {
          "embeds": [{
            "title": "ðŸš€ New Release: $NAME",
            "url": "$URL",
            "description": "ðŸ“ **What's Changed:**\n$ESCAPED_WHATS_CHANGED\n\nðŸ“¦ [Full Changelog]($FULL_CHANGELOG_URL)",
            "color": 3447003
          }]
        }
        EOF
        )
        
        curl -H "Content-Type: application/json" -X POST -d "$DISCORD_PAYLOAD" "$DISCORD_WEBHOOK"