name: Release Changelog to Discord

on:
  release:
    types: [published]

jobs:
  notify-discord:
    if: github.event.release.target_commitish == 'main'
    runs-on: ubuntu-latest

    steps:
    - name: Format and send changelog to Discord
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        PAYLOAD='${{ toJson(github.event.release) }}'

        BODY=$(echo "$PAYLOAD" | jq -r '.body')
        TAG_NAME=$(echo "$PAYLOAD" | jq -r '.tag_name')
        NAME=$(echo "$PAYLOAD" | jq -r '.name')
        URL=$(echo "$PAYLOAD" | jq -r '.html_url')

        echo "---- BODY ----"
        echo "$BODY"
        echo "---- TAG_NAME ----"
        echo "$TAG_NAME"
        echo "---- NAME ----"
        echo "$NAME"
        echo "---- URL ----"
        echo "$URL"

        WHATS_CHANGED=$(echo "$BODY" | awk '/## [Ww]hat.?s [Cc]hanged/{flag=1; next} /^## /{flag=0} flag')
        WHATS_CHANGED="${WHATS_CHANGED:-No changes listed.}"
        FULL_CHANGELOG_URL=$(echo "$BODY" | grep -o 'https://github.com[^ ]*commits[^ ]*' || echo "$URL")

        echo "---- WHATS_CHANGED ----"
        echo "$WHATS_CHANGED"
        echo "---- FULL_CHANGELOG_URL ----"
        echo "$FULL_CHANGELOG_URL"

        DESCRIPTION=$(printf "ðŸ“ **What's Changed:**\n%s\n\nðŸ“¦ [Full Changelog](%s)" "$WHATS_CHANGED" "$FULL_CHANGELOG_URL")

        echo "---- DESCRIPTION (raw) ----"
        printf "%s\n" "$DESCRIPTION"

        jq -n --arg title "ðŸš€ New Release: $NAME" \
              --arg url "$URL" \
              --arg description "$DESCRIPTION" \
              --argjson color 3447003 \
              '{
                embeds: [
                  {
                    title: $title,
                    url: $url,
                    description: $description,
                    color: $color
                  }
                ]
              }' > payload.json

        echo "---- FINAL payload.json ----"
        cat payload.json

        curl -H "Content-Type: application/json" -X POST -d @payload.json "$DISCORD_WEBHOOK"
