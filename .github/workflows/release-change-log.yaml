name: Release Changelog to Discord

on:
  release:
    types: [published]

jobs:
  notify-discord:
    if: github.event.release.target_commitish == 'main'
    runs-on: ubuntu-latest

    steps:
      - name: Format and send changelog to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          PAYLOAD='${{ toJson(github.event.release) }}'

          echo "$PAYLOAD" > payload_raw.json

          BODY=$(jq -r '.body' <<< "$PAYLOAD")
          TAG_NAME=$(jq -r '.tag_name' <<< "$PAYLOAD")
          NAME=$(jq -r '.name' <<< "$PAYLOAD")
          URL=$(jq -r '.html_url' <<< "$PAYLOAD")

          WHATS_CHANGED=$(echo "$BODY" | awk '/## [Ww]hat.s [Cc]hanged/{flag=1; next} /^## /{flag=0} flag')
          FULL_CHANGELOG_URL=$(echo "$BODY" | grep -o 'https://github.com[^ ]*commits[^ ]*' || echo "$URL")

          DESCRIPTION="ðŸ“ **What's Changed:**\n$WHATS_CHANGED\n\nðŸ“¦ [Full Changelog]($FULL_CHANGELOG_URL)"

          jq -n \
            --arg title "ðŸš€ New Release: $NAME" \
            --arg url "$URL" \
            --arg description "$DESCRIPTION" \
            --argjson color 3447003 \
            '{
              embeds: [{
                title: $title,
                url: $url,
                description: $description,
                color: $color
              }]
            }' > payload.json

          echo "Payload JSON for Discord:"
          cat payload.json

          curl -H "Content-Type: application/json" \
               -X POST -d @payload.json "$DISCORD_WEBHOOK"
