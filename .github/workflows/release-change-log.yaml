name: Release Changelog to Discord

on:
  release:
    types: [published]

jobs:
  notify-discord:
    if: github.event.release.target_commitish == 'main'
    runs-on: ubuntu-latest

    steps:
    - name: Format and send changelog to Discord
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        PAYLOAD='${{ toJson(github.event.release) }}'

        BODY=$(echo "$PAYLOAD" | jq -r '.body')
        NAME=$(echo "$PAYLOAD" | jq -r '.name')
        URL=$(echo "$PAYLOAD" | jq -r '.html_url')

        # Escape backslashes, quotes, and wrap in triple backticks for code block
        ESCAPED_BODY=$(printf '%s\n' "$BODY" | sed 's/\\/\\\\/g; s/"/\\"/g')
        CODE_BLOCK="\\\`\\\`\\\`\\n$ESCAPED_BODY\\n\\\`\\\`\\\`"

        curl -H "Content-Type: application/json" \
          -X POST \
          -d "{
            \"embeds\": [{
              \"title\": \"ðŸš€ New Release: $NAME\",
              \"url\": \"$URL\",
              \"description\": \"$CODE_BLOCK\",
              \"color\": 3447003
            }]
          }" \
          "$DISCORD_WEBHOOK"
