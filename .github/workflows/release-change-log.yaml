name: Release Changelog to Discord

on:
  release:
    types: [published]

jobs:
  notify-discord:
    if: github.event.release.target_commitish == 'main'
    runs-on: ubuntu-latest

    steps:
    - name: Check out the repo
      uses: actions/checkout@v4

    - name: Generate changelog
      id: changelog
      run: |
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ -z "$PREVIOUS_TAG" ]; then
          CHANGELOG=$(git log --no-merges --pretty=format:"- %s")
        else
          CHANGELOG=$(git log --no-merges --pretty=format:"- %s" $PREVIOUS_TAG..HEAD)
        fi

        if [ -z "$CHANGELOG" ]; then
          CHANGELOG="- No changes detected"
        fi

        echo "CHANGELOG<<EOF" >> $GITHUB_ENV
        echo "$CHANGELOG" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - name: Send changelog to Discord
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        CHANGELOG: ${{ env.CHANGELOG }}
        RELEASE_TAG: ${{ github.event.release.tag_name }}
      run: |
        curl -H "Content-Type: application/json" \
          -X POST \
          -d "{\"username\": \"Release Bot\", \"embeds\": [{\"title\": \"ðŸš€ New Release: $RELEASE_TAG\", \"description\": \"$CHANGELOG\"}]}" \
          $DISCORD_WEBHOOK
