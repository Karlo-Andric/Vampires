name: Release Changelog to Discord

on:
  release:
    types: [published]

jobs:
  notify-discord:
    if: github.event.release.target_commitish == 'main'
    runs-on: ubuntu-latest

    steps:
    - name: Send release title to Discord
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        PAYLOAD='${{ toJson(github.event.release) }}'

        BODY=$(echo "$PAYLOAD" | jq -r '.body')
        TAG_NAME=$(echo "$PAYLOAD" | jq -r '.tag_name')
        URL=$(echo "$PAYLOAD" | jq -r '.html_url')

        jq -n --arg title "ðŸš€ $TAG_NAME released!" \
              --arg url "$URL" \
              --argjson color 3447003 \
              '{embeds: [{title: $title, url: $url, color: $color}]}' \
          > embed.json

        curl -H "Content-Type: application/json" \
             -X POST \
             --data @embed.json \
             "$DISCORD_WEBHOOK"

        echo "$BODY" > body.txt

        jq -n --rawfile content body.txt '{content: $content}' > body.json

        curl -H "Content-Type: application/json" \
             -X POST \
             --data @body.json \
             "$DISCORD_WEBHOOK"
